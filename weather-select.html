<html>
<script>
  // Wet race probability for each track
  const trackWetProbabilities = [
    { name: "Bahrain", wetChance: 0.02 },
    { name: "Saudi Arabia", wetChance: 0.05 },
    { name: "Australia", wetChance: 0.1 },
    { name: "Imola", wetChance: 0.15 },
    { name: "Miami", wetChance: 0.2 },
    { name: "Spain", wetChance: 0.2 },
    { name: "Monaco", wetChance: 0.2 },
    { name: "Azerbaijan", wetChance: 0.1 },
    { name: "Canada", wetChance: 0.3 },
    { name: "Great Britain", wetChance: 0.4 },
    { name: "Austia", wetChance: 0.2 },
    { name: "France", wetChance: 0.3 },
    { name: "Hungary", wetChance: 0.25 },
    { name: "Belgium", wetChance: 0.3 },
    { name: "Netherlands", wetChance: 0.3 },
    { name: "Italy", wetChance: 0.15 },
    { name: "Singapore", wetChance: 0.2 },
    { name: "Japan", wetChance: 0.2 },
    { name: "USA", wetChance: 0.15 },
    { name: "Mexico", wetChance: 0.2 },
    { name: "Brazil", wetChance: 0.2 },
    { name: "Abu Dhabi", wetChance: 0.05 },
    { name: "Portugal", wetChance: 0.2 },
    { name: "China", wetChance: 0.2 },
  ];

  // List of weather types
  const weatherTypes = [
    "clear",
    "lightCloud",
    "overcast",
    "wet",
    "veryWet",
  ];

  const getNextStintWeatherProbabilities = (currentStintWeatherType, wetChance) => {
    const nextStintWeatherProbabilities = weatherTypes.map((weatherType, index) => {
      const currentStintWeatherIndex = weatherTypes.indexOf(currentStintWeatherType);
      const differenceToCurrentWeather = Math.abs(currentStintWeatherIndex - index);
      const weatherTypeProbability = (1 - ((differenceToCurrentWeather + 1) * 0.2)) * getWeatherTypeProbability(weatherType, wetChance);
     
      return {type: weatherType, probability: weatherTypeProbability};
    });

    return nextStintWeatherProbabilities;
  };

  // Returns probability of selecting each weather type based on wet chance given
  const getWeatherTypeProbability = (weatherType, wetChance) => {
    switch (weatherType) {
      case "clear":
        return (1 - wetChance) / 3;
      case "lightCloud":
        return (1 - wetChance) / 3;
      case "overcast":
        return (1 - wetChance) / 3;
      case "wet":
        return wetChance / 2;
      case "veryWet":
        return wetChance / 2;
      default:
        return 1;
    }
  };

  // Gets probability of each weather type for a given wet chance
  const getFirstStintWeatherTypeProbabilities = (wetChance) => {
    const weightedWeatherTypes = weatherTypes.map((weatherType) => {
      return {
        type: weatherType,
        probability: getWeatherTypeProbability(weatherType, wetChance),
      };
    });

    return weightedWeatherTypes;
  };

  const getWeatherTypeFromProbabilities = (weatherTypeProbabilities) => {
    const probabilityRangeMax = weatherTypeProbabilities.reduce(
      (totalRange, weatherTypeProbability) => {
        const upperProbabilityRange =
          weatherTypeProbability.probability + totalRange;
        weatherTypeProbability.probability = upperProbabilityRange;
        return upperProbabilityRange;
      },
      0
    );

    const randomizedValue = Math.random() * probabilityRangeMax;

    const selectedWeatherType = weatherTypeProbabilities.find(
      (weatherTypeProbability) =>
        weatherTypeProbability.probability > randomizedValue
    )?.type;

    return selectedWeatherType;
  };

  const getFirstStintWeatherType = (wetChanceForTrack) => {
    const weatherTypeProbabilities =
      getFirstStintWeatherTypeProbabilities(wetChanceForTrack);

    const firstStintWeather = getWeatherTypeFromProbabilities(weatherTypeProbabilities);

    return firstStintWeather;
  };

  const getOtherStintWeatherType = (previousWeatherType, wetChance) => {
    const weatherTypeProbabilities = getNextStintWeatherProbabilities(previousWeatherType, wetChance);
    const nextStintWeather = getWeatherTypeFromProbabilities(weatherTypeProbabilities);
    return nextStintWeather;
  }

  // Selects weather type for a track
  const selectWeather = (selectedTrack) => {
    const wetChance = trackWetProbabilities.find(
      (el) => el.name === selectedTrack
    )?.wetChance;
    const firstStintWeather = getFirstStintWeatherType(wetChance);

    const secondStintWeather = getOtherStintWeatherType(firstStintWeather, wetChance);

    const thirdStintWeather = getOtherStintWeatherType(secondStintWeather, wetChance);


    return [firstStintWeather, secondStintWeather, thirdStintWeather];
  };

  const handleRunOnce = () => {
    const track = document.getElementById('trackSelect').value;
    const raceWeather = selectWeather(track);
    document.getElementById('firstStint').value = raceWeather[0];
    document.getElementById('secondStint').value = raceWeather[1];
    document.getElementById('thirdStint').value = raceWeather[2];
  };

  const handleRun50 = () => {
    const track = document.getElementById('trackSelect').value;
    const runCount = document.getElementById('runCount')?.value;

    const numberOfSelections = runCount || 50;
    const weatherSelections = [];
    for (let i = 0; i < numberOfSelections; i++) {
      const raceWeather = selectWeather(track);
      weatherSelections.push(raceWeather);
    }

    const wetWeatherTypes = [
      "wet",
      "veryWet",
    ];

    const wetRaceCount = weatherSelections.filter(raceWeather => raceWeather.some(stint => wetWeatherTypes.includes(stint))).length;

    const clearStintPercentage = Math.round(weatherSelections.reduce(
      (totalCount, raceWeather) => totalCount + raceWeather.filter(stint => stint === "clear").length
    , 0) / (numberOfSelections * 3) * 100);
    const lightCloudStintPercentage = Math.round(weatherSelections.reduce(
      (totalCount, raceWeather) => totalCount + raceWeather.filter(stint => stint === "lightCloud").length
    , 0) / (numberOfSelections * 3) * 100);
    const overcastStintPercentage = Math.round(weatherSelections.reduce(
      (totalCount, raceWeather) => totalCount + raceWeather.filter(stint => stint === "overcast").length
    , 0) / (numberOfSelections * 3) * 100);
    const wetStintPercentage = Math.round(weatherSelections.reduce(
      (totalCount, raceWeather) => totalCount + raceWeather.filter(stint => stint === "wet").length
    , 0) / (numberOfSelections * 3) * 100);
    const veryWetStintPercentage = Math.round(weatherSelections.reduce(
      (totalCount, raceWeather) => totalCount + raceWeather.filter(stint => stint === "veryWet").length
    , 0) / (numberOfSelections * 3) * 100);

    const wetRacePercentage = Math.round((wetRaceCount / numberOfSelections) * 100);
    const dryRacePercentage = 100 - wetRacePercentage;

    document.getElementById('clearStintPercentageInput').value = clearStintPercentage;
    document.getElementById('lightCloudStintPercentageInput').value = lightCloudStintPercentage;
    document.getElementById('overcastStintPercentageInput').value = overcastStintPercentage;
    document.getElementById('wetStintPercentageInput').value = wetStintPercentage;
    document.getElementById('veryWetStintPercentageInput').value = veryWetStintPercentage;

    document.getElementById('dryRacePercentageInput').value = dryRacePercentage;
    document.getElementById('wetRacePercentageInput').value = wetRacePercentage;
  };

  window.onload = function () {
    document.getElementById('runOnce').onclick = handleRunOnce;
    document.getElementById('run50').onclick = handleRun50;
  };

</script>

<body>
  <div>
    <label for="trackSelect">Choose a track:</label>

    <select id="trackSelect" name="trackSelect">
      <option value="Bahrain">Bahrain</option>
      <option value="Saudi Arabia">Saudi Arabia</option>
      <option value="Australia">Australia</option>
      <option value="Imola">Imola</option>
      <option value="Miami">Miami</option>
      <option value="Spain">Spain</option>
      <option value="Monaco">Monaco</option>
      <option value="Azerbaijan">Azerbaijan</option>
      <option value="Canada">Canada</option>
      <option value="Great Britain">Great Britain</option>
      <option value="Austia">Austia</option>
      <option value="France">France</option>
      <option value="Hungary">Hungary</option>
      <option value="Belgium">Belgium</option>
      <option value="Netherlands">Netherlands</option>
      <option value="Italy">Italy</option>
      <option value="Singapore">Singapore</option>
      <option value="Japan">Japan</option>
      <option value="USA">USA</option>
      <option value="Mexico">Mexico</option>
      <option value="Brazil">Brazil</option>
      <option value="Abu Dhabi">Abu Dhabi</option>
      <option value="Portugal">Portugal</option>
      <option value="China">China</option>
    </select>

    <button id="runOnce">What's the weather like Ollie?</button>

    <input id="firstStint"></input>
    <input id="secondStint"></input>
    <input id="thirdStint"></input>
  </div>
  <div>
    <button id="run50">Run it a bunch? (default 50 times)</button>
    <input id="runCount"></input>
    <div>
      <div>
        <label>Percentage of clear stints:</label>
        <input id="clearStintPercentageInput"></input>
      </div>
      <div>
        <label>Percentage of lightCloud stints:</label>
        <input id="lightCloudStintPercentageInput"></input>
      </div>
      <div>
        <label>Percentage of overcast stints:</label>
        <input id="overcastStintPercentageInput"></input>
      </div>
      <div>
        <label>Percentage of wet stints:</label>
        <input id="wetStintPercentageInput"></input>
      </div>
      <div>
        <label>Percentage of veryWet stints:</label>
        <input id="veryWetStintPercentageInput"></input>
      </div>
    </div>
    <div>
      <div>
        <label>Percentage of dry races:</label>
        <input id="dryRacePercentageInput"></input>
      </div>
      <div>
        <label>Percentage of wet races:</label>
        <input id="wetRacePercentageInput"></input>
      </div>
    </div>
  </div>

</body>

</html>